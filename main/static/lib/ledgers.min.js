(function(){async function a(a,b){switch(a){case p:if(!("address"in b))throw new Error("'address' must be passed in");if(!("secret"in b))throw new Error("'secret' must be passed in");s.OHLEDGER_IMPARTER_TAG.address=b.address,s.OHLEDGER_IMPARTER_TAG.secret=b.secret;try{if(web3.eth.accounts.recover(web3.eth.accounts.sign("test message",b.secret)).toLowerCase()!=b.address.toLowerCase())throw new Error("'secret' not valid for 'address")}catch(a){throw new Error("'secret' not valid for 'address")}return n.oh$.onCredentialsUpdate&&n.oh$.onCredentialsUpdate(p,{address:b.address,secret:b.secret}),!0;default:return!1;}}async function b(a,b){if(o==a)return!1;if(!("currency"in b))throw new Error("'currency' must be passed in");if(!("mode"in b))throw new Error("'mode' must be passed in");if(b.currency=b.currency.toUpperCase(),b.mode=b.mode.toLowerCase(),"USD"!==b.currency)throw new Error("'currency' must be 'USD'");if("prod"!==b.mode&&"test"!==b.mode)throw new Error("'mode' must be 'prod' or 'test'");return"ohledger"===a?(s.OHLEDGER_IMPARTER_TAG.mode=b.mode,n.oh$.onNetworkChange&&n.oh$.onNetworkChange(p,{currency:"USD",mode:b.mode,uri:s.OHLEDGER_IMPARTER_TAG.remuneration_uri[b.mode]}),!0):"ohledger-web3"===a&&(s.OHLEDGER_WEB3_IMPARTER_TAG.mode=b.mode,n.oh$.onNetworkChange&&n.oh$.onNetworkChange(q,{currency:"USD",mode:b.mode,uri:s.OHLEDGER_WEB3_IMPARTER_TAG.remuneration_uri[b.mode]}),!0)}function c(a){switch(a){case p:if(!s.OHLEDGER_IMPARTER_TAG.mode)throw new Error("network 'mode' must be set, use setNetwork");return s.OHLEDGER_IMPARTER_TAG.remuneration_uri[s.OHLEDGER_IMPARTER_TAG.mode];case q:if(!s.OHLEDGER_WEB3_IMPARTER_TAG.mode)throw new Error("network 'mode' must be set, use setNetwork");return s.OHLEDGER_WEB3_IMPARTER_TAG.remuneration_uri[s.OHLEDGER_WEB3_IMPARTER_TAG.mode];case o:return s.ETH_WEB3_IMPARTER_TAG.remuneration_uri[s.ETH_WEB3_IMPARTER_TAG.network];default:return null;}}async function d(a,b,d,e){if(d&&!(d instanceof Date))throw new Error("'date' must be a Date is passed in");if(!("address"in b))throw new Error("'address' required in recipient");let f=b.address,g=c(a);switch(a){case p:if(!s.OHLEDGER_IMPARTER_TAG.mode)throw new Error("network 'mode' must be set, use setNetwork");if(!s.OHLEDGER_IMPARTER_TAG.address)throw new Error("from 'address' not set: use setCredentials");var h=s.OHLEDGER_IMPARTER_TAG.address;break;case q:if(!s.OHLEDGER_WEB3_IMPARTER_TAG.mode)throw new Error("network 'mode' must be set, use setNetwork");if(!s.OHLEDGER_WEB3_IMPARTER_TAG.walletAddress)throw new Error("from 'walletAddress' not set: use wallet");var h=s.OHLEDGER_WEB3_IMPARTER_TAG.walletAddress;break;case o:if(!s.ETH_WEB3_IMPARTER_TAG.network)throw new Error("no network for imparter tag");if(!s.ETH_WEB3_IMPARTER_TAG.walletAddress)throw new Error("from 'walletAddress' not set: use wallet");var h=s.ETH_WEB3_IMPARTER_TAG.walletAddress;break;default:throw new Error("unsupported imparter tag");}if(!g)throw new Error("no uri for request, unsupported network selected in wallet?");let i="";return d&&(i=`&since=${d.toISOString()}`),await fetch(`${g}/get-transactions/${h}/${f}?tally-only=${e?"true":"false"}${i}`).then(a=>a.json()).catch(a=>{throw a+""})}async function e(a){let b=c(a);switch(a){case p:if(!s.OHLEDGER_IMPARTER_TAG.mode)throw new Error("network 'mode' must be set, use setNetwork");if(!s.OHLEDGER_IMPARTER_TAG.address)throw new Error("from 'address' not set: use setCredentials");var d=s.OHLEDGER_IMPARTER_TAG.address;break;case q:if(!s.OHLEDGER_WEB3_IMPARTER_TAG.mode)throw new Error("network 'mode' must be set, use setNetwork");if(!s.OHLEDGER_WEB3_IMPARTER_TAG.walletAddress)throw new Error("from 'walletAddress' not set: use wallet");var d=s.OHLEDGER_WEB3_IMPARTER_TAG.walletAddress;break;case o:if(!s.ETH_WEB3_IMPARTER_TAG.network)throw new Error("no network for imparter tag");if(!s.ETH_WEB3_IMPARTER_TAG.walletAddress)throw new Error("from 'walletAddress' not set: use wallet");var d=s.ETH_WEB3_IMPARTER_TAG.walletAddress;break;default:throw new Error("unsupported imparter tag");}if(!b)throw new Error("no uri for request, unsupported network selected in wallet?");let e=await f(a,"verify ownership of address by signing");return await fetch(`${b}/is-signature-valid`,{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify({signature:btoa(e),message:btoa("verify ownership of address by signing"),address:d})}).then(a=>200==a.status).catch(a=>{throw a+""})}async function f(a,b){switch(a){case p:if(!s.OHLEDGER_IMPARTER_TAG.secret)throw new Error(`credentials for imparter ${p} not set`);return web3.eth.accounts.sign(b,s.OHLEDGER_IMPARTER_TAG.secret).signature;case q:if(!s.OHLEDGER_WEB3_IMPARTER_TAG.walletAddress)throw new Error(`imparter ${q} not active`);return n.oh$.onWalletPopup&&n.oh$.onWalletPopup(q),await window.web3.eth.personal.sign(b,s.OHLEDGER_WEB3_IMPARTER_TAG.walletAddress);case o:if(!s.ETH_WEB3_IMPARTER_TAG.walletAddress)throw new Error(`imparter ${o} not active`);return n.oh$.onWalletPopup&&n.oh$.onWalletPopup(o),await window.web3.eth.personal.sign(b,s.ETH_WEB3_IMPARTER_TAG.walletAddress);default:return null;}}async function g(a,b,c,d){if(0==b&&(await e(a)))return!0;switch(a){case p:if(!s.OHLEDGER_IMPARTER_TAG.mode)throw new Error("network 'mode' must be set, use setNetwork");if(!s.OHLEDGER_IMPARTER_TAG.address)throw new Error("from 'address' not set: use setCredentials");var g=s.OHLEDGER_IMPARTER_TAG.address;break;case q:if(!s.OHLEDGER_WEB3_IMPARTER_TAG.mode)throw new Error("network 'mode' must be set, use setNetwork");if(!s.OHLEDGER_WEB3_IMPARTER_TAG.walletAddress)throw new Error("from 'walletAddress' not set: use wallet");var g=s.OHLEDGER_WEB3_IMPARTER_TAG.walletAddress;break;case o:if(!s.ETH_WEB3_IMPARTER_TAG.network)throw new Error("no network for imparter tag");if(!s.ETH_WEB3_IMPARTER_TAG.walletAddress)throw new Error("from 'walletAddress' not set: use wallet");var g=s.ETH_WEB3_IMPARTER_TAG.walletAddress;break;default:throw new Error("unsupported imparter tag");}switch(a){case p:case q:if(0==b){if("message"in d&&"signature"in d)i=d.message,j=d.signature;else var i=`verify ownership of address by signing on ${new Date().toLocaleString()}`,j=await f(a,i);await l(a,g,j,i)}else{let a=h();s.OHLEDGER_IMPARTER_TAG.oh_ledger_transact_fn[s.OHLEDGER_IMPARTER_TAG.mode](b,g,c),await a}break;case o:n.oh$.onWalletPopup&&n.oh$.onWalletPopup(o),await web3.eth.sendTransaction({from:g,to:c,value:b});break;default:throw new Error("unsupported imparter tag");}return!0}function h(){return console.assert(!t,"oh-popup promise being set but already set when calling setupNewPromise(..)"),new Promise((a,b)=>{t=a,u=b})}function i(){var a=document.getElementById("oh-popup-container");return a.style.display="block",h()}function j(a,b){var c=document.getElementById("oh-popup-container");k(),c.style.display="none",console.assert(t,"oh-popup promise not set yet calling makePopupHidden(..)"),b?u(a):t(a),t=null,u=null}function k(){document.getElementById("oh-ledger-gratis-iframe").style.display="none"}async function l(a,b,d,e){k();let f=c(a);var g=document.getElementById("oh-ledger-gratis-iframe");g.setAttribute("src",`${f}/gratis.html?address=${b}&signature=${d}&message=${e}`),g.style.display="block",await i()}function m(){v(`${s.OHLEDGER_IMPARTER_TAG.remuneration_uri.prod}/transact.js`,()=>{s.OHLEDGER_IMPARTER_TAG.oh_ledger_transact_fn.prod=oh_ledger_transact,s.OHLEDGER_WEB3_IMPARTER_TAG.oh_ledger_transact_fn.prod=oh_ledger_transact},document.body),v(`${s.OHLEDGER_IMPARTER_TAG.remuneration_uri.test}/transact.js`,()=>{s.OHLEDGER_IMPARTER_TAG.oh_ledger_transact_fn.test=oh_ledger_transact,s.OHLEDGER_WEB3_IMPARTER_TAG.oh_ledger_transact_fn.test=oh_ledger_transact},document.body)}var n="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||this||{};n.oh$={onWalletChange:null,onWalletPopup:null,onCredentialsUpdate:null,onNetworkChange:null,getImparterTags:function(){return r},canSetCredentials:function(a){return a===p},canGenerateCredentials:function(a){return a===p},canChangeNetwork:function(a){return!(a!=="ohledger"&&a!=="ohledger-web3")},generateCredentials:async function(a){switch(a){case p:let b=window.web3.eth.accounts.create();return s.OHLEDGER_IMPARTER_TAG.address=b.address,s.OHLEDGER_IMPARTER_TAG.secret=b.privateKey,n.oh$.onCredentialsUpdate&&n.oh$.onCredentialsUpdate(p,{address:b.address,secret:b.privateKey}),!0;default:return!1;}},setCredentials:a,setNetwork:b,getOverhideRemunerationAPIUri:c,getTally:async function(a,b,c){return(await d(a,b,c,!0)).tally},getTransactions:async function(a,b,c){return(await d(a,b,c,!1)).transactions},isOnLedger:e,sign:f,createTransaction:g};const o="eth-web3",p="ohledger",q="ohledger-web3";var r=[p],s={ETH_WEB3_IMPARTER_TAG:{walletAddress:null,network:null,remuneration_uri:{main:"https://ethereum.overhide.io",rinkeby:"https://rinkeby.ethereum.overhide.io"}},OHLEDGER_IMPARTER_TAG:{oh_ledger_transact_fn:{prod:null,test:null},address:null,secret:null,mode:"test",remuneration_uri:{prod:"https://ledger.overhide.io/v1",test:"https://test.ledger.overhide.io/v1"}},OHLEDGER_WEB3_IMPARTER_TAG:{oh_ledger_transact_fn:{prod:null,test:null},walletAddress:null,mode:"test",remuneration_uri:{prod:"https://ledger.overhide.io/v1",test:"https://test.ledger.overhide.io/v1"}}};(function(){var a=document.createElement("div");a.setAttribute("id","oh-popup-container"),a.style.display="none",a.innerHTML=`
      <div>
        <a href="#" title="Close" id="oh-popup-close" onclick="window.parent.document.dispatchEvent(new CustomEvent('oh$-popup-close',{})); return false;">X</a>
        <iframe id="oh-ledger-gratis-iframe"></iframe>
      </div>
    `;var b=document.createElement("style");b.innerHTML=`
      #oh-popup-container {
          position: fixed;
          font-family: arial, "lucida console", sans-serif;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          background: rgba(0, 0, 0, 0.8);
          z-index: 999;
          opacity:1;
          pointer-events: auto;
      }
      #oh-popup-container > div {
          width: 80vw;
          height: 75vh;
          position: relative;
          top: 15vh;
          margin: auto auto;
          padding: 5px 5px 5px 5px;
          background: white;
      }
      #oh-popup-close {
          background: grey;
          color: white;
          line-height: 25px;
          position: absolute;
          right: 2px;
          text-align: center;
          top: 2px;
          width: 24px;
          text-decoration: none;
          font-weight: bold;
      }
      #oh-popup-close:hover {
          background: black;
      }

      #oh-ledger-gratis-iframe {
        display: none;
        border: 0;
        overflow: hidden;
        width: 100%;
        height: 100%;
      }
    `;var c=()=>{document.body?(document.body.appendChild(a),document.body.appendChild(b),m()):setTimeout(c,100)};c()})(),function(){if(window.web3=new Web3,window.ethereum){(async()=>{try{await ethereum.enable(),window.web3=new Web3(ethereum)}catch(a){}await a(),setInterval(async function(){await a()},500)})();var a=async()=>{try{var a=(await window.web3.eth.getAccounts())[0],b=await window.web3.eth.net.getNetworkType()}catch(a){}if(a!==s.ETH_WEB3_IMPARTER_TAG.walletAddress){let b=r.findIndex(a=>a===o);b&&!a?r.splice(b,1):!b&&a&&(r.push(o),r.push(q)),s.ETH_WEB3_IMPARTER_TAG.walletAddress=a,s.OHLEDGER_WEB3_IMPARTER_TAG.walletAddress=a,n.oh$.onWalletChange&&(n.oh$.onWalletChange(o,!!a),n.oh$.onWalletChange(q,!!a)),n.oh$.onCredentialsUpdate&&a&&(n.oh$.onCredentialsUpdate(o,{address:a}),n.oh$.onCredentialsUpdate(q,{address:a}))}b!==s.ETH_WEB3_IMPARTER_TAG.network&&(n.oh$.onNetworkChange&&n.oh$.onNetworkChange(o,{name:b,uri:s.ETH_WEB3_IMPARTER_TAG.remuneration_uri[b]}),s.ETH_WEB3_IMPARTER_TAG.network=b)}}}();var t=null,u=null;window.addEventListener("message",a=>{a.data&&"oh-ledger-ok"===a.data.event?j(a.data.detail):a.data&&"oh-ledger-error"===a.data.event&&j(a.data.detail,!0)},!1),window.document.addEventListener("oh$-popup-close",()=>{j("user close",!0)});var v=function(a,b,c){var d=document.createElement("script");d.src=a,d.onload=b,d.onreadystatechange=b,c.appendChild(d)}})();